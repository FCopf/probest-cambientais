# Processamento de dados {#procdados}

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(message = FALSE, echo = FALSE)
```

Tabelas de dados como a apresentada no capítulo \@ref(estrdados) são normalmente armazenadas em planilhas eletrônicas. Os formatos mais comuns para armazenamento são arquivos do tipo `.xlsx`, `.csv`, `.txt` e mais recentemente planilhas em nuvem (ex. google sheets). Os programas para visualização e destes tipos de arquivos são apropriados para inserção e armazenamendo de dados, mas apresentam limitações para o processamento, descrição e visualização.

Neste capítulo iremos utilizar a linguagem estatística [R](https://www.r-project.org/) e o ambiente de trabalho [RStudio](https://rstudio.com/) para aplicar algumas ações comuns ao processamento inicial de dados. O objetivo é que a base de dados original permaneça inalterada e que todo o processamento seja feito em uma versão da base de dados que será importada para o programa R. Isto evita que sejam feitas alterações equivocadas diretamente na base de dados resultando na perda da informação original.

> Neste capítulo veremos como preparar um novo projeto na linguagem R. Para mais detalhes veja apostila: [Introdução ao Ambiente R de Programação](https://fcopf.github.io/probest-introR/).

## Criando seu projeto de trabalho no RStudio

Se você utiliza o RStudio com ambiente de trabalho para a linguagem R, o modo mais organizado de gerenciar suas análises é criando um **Projeto**. Você pode criar um projeto via menu: `File`, escolhendo a opção `New Project`. Ao abrir a janela, escolha novamente `New Project`. Em `Directory name:` escreva o nome de seu projeto e em `Create a project as subdirectory of:` escolha diretório de seu computador em que o projeto será criado. Finalmente pressione `Create Project`.

Ao fazer isto, será criada uma nova pasta com o nome que você escolheu para o projeto. Dentro desta pasta você encontrará um arquivo de extensão `.Rproj` com o nome de seu projeto.

A partir deste momento, sempre que você for trabalhar neste projeto, abra o RStudio pressionando duas vezes o mouse sobre o arquivo `.Rproj`. Ao fazer isto, o R saberá qual diretório de trabalho você está utilizando e onde  estarão os documentos relacionados ao projeto. Utilizar projetos no RStudio torna mais simples a organização dos arquivos, pois todas as base de dados bem como o material gerado (figuras, slides, arquivos `.pdf`,  etc) podem ser organizados em sub-diretórios do projeto.

### Iniciando o projeto `Intro_estatistica`

Na pasta *Documentos* crie um projeto denominado `Intro_estatistica`. Após criar o projeto, verifique se o R está realmente direcionado para este local. Vá ao console do RStudioo e digitre o comando `getwd()`.

```{r, echo = TRUE, eval=FALSE}
getwd()
```

```{r, echo = FALSE, include = TRUE}
cat('[1] "C:/Users/f_cop/Documents/Intro_estatistica"')
```
Como resultado você verá uma saída parecida com a apresentada acima, contendo o caminho do projeto em seu computador.

## Inserindo uma base de dados no diretório do projeto

Vá ao no link do [GitHub](https://github.com/FCopf/probest-cambientais/blob/master/datasets/Reservatorios_Parana_parcial.csv) para acessar a base de dados que iremos utilizar neste capítulo. Após clicar, a janela do navegador irá mostrar um arquivo texto com os dados da planilha `Reservatorios_Parana_parcial.csv` que discutimos no capítulo \@ref(estrdados). A primeira linha corresponde ao nome de cada variável, enquanto as demais linhas contém os dados de cada reservatório.

Abra um bloco de notas em seu computador, copie os dados do arquivo texto (inclusive o nome das colunas) selecionando-os com o mouse e copie no bloco de notas. Em seguida salve seu bloco de notas com o nome `Reservatorios_Parana_parcial.csv` dentro da pasta `Intro_estatistica`.

Agora, você já tem a base de dados em sua pasta de trabalho. Para garantir que tudo esteja correto, verifique se o R reconhece este arquivo, digitando o comando `dir()` no console do RStudio:

```{r, echo = TRUE, eval=FALSE}
dir()
```

```{r, echo = FALSE, include = TRUE}
cat('[1] "Intro_estatistica.Rproj"', '\n', '[2] "Reservatorios_Parana_parcial.csv"')
```

Se tudo estiver correto, sua pasta de trabalho deve conter dois arquivos: `Intro_estatistica.Rproj` e `Reservatorios_Parana_parcial.csv`.

## Preparando o ambiente de trabalho

**Instalação de pacotes**

Caso ainda não tenha feito, instale o pacote `tidyverse`. Para isto digite:

```{r, echo = TRUE, eval=FALSE}
install.packages("tidyverse")
```

Para mais detalhes sobre o pacote acesse a [apostila do R](https://fcopf.github.io/probest-introR/tidy.html) e o [site oficial](https://www.tidyverse.org/).

**Novo script `.R`**

No RStudio vá em `File --> New File --> RScript` para criar um novo arquivo e após criado, salve-o como `aula_01.R`. A partir de agora, todos os comandos desta aula serão digitados dentro deste arquivo texto. Para rodar cada comando, pressione o botão `Run` no RStudio ou digite as teclas de atalho `Ctrl + Enter`. Não se esqueça de salvar o arquivo texto à medida que adiciona novos comandos.


## Carregando os pacotes

Antes de iniciar com os comandos, carregue o pacote `tidyverse`

```{r, echo = T, eval = FALSE}
# Carrega pacotes
library(tidyverse)
```

Sempre que você iniciar uma seção do R deverá carregar os pacotes necessários. Para esta aula utilizaremos somente algumas funções inseridas no pacote `tidyverse`. 

## Importanto a base de dados

Use a função `read_delim`

```{r}
# Importa base de dados 
res = read_delim('datasets/Reservatorios_Parana_parcial.csv',
                  delim = ',',
                  locale = locale(decimal_mark = '.',
                                  encoding = 'latin1'))
```

```{r, echo = TRUE, eval=FALSE}
# Importa base de dados 
res = read_delim('Reservatorios_Parana_parcial.csv',
                  delim = ',',
                  locale = locale(decimal_mark = '.',
                                  encoding = 'latin1'))
```

Ao rodar este comando, o R terá uma tabela denominada `res` com as informações lidas da base de dados.

Vamos entender alguns argumentos:

+ `delim = ','`: utilizado para dizer ao R que cada coluna na base de dados é separada por uma vírgula. Se o arquivo `.csv` estivesse separando as colunas por *ponto-e-vígula* como também é comum, deveríamos escrever `delim = ';'`.

+ `decimal_mark = '.'`: diz para o R entender o símbolo *ponto* como um separador decimal. Se no arquivo `.csv` estivesse separando os números decimais com uma vírgula, o argumento seria `decimal_mark = ','`.

+ `encoding = 'latin1'` indica a forma de codificação. A necessidade de seu uso depende do sistema operacional de seu computador. Outras formas de codificação além de `latim1` são `UTF-8`, `ISO-8859-1`, entre outros. O argumento é necessário geralmente quando há caracteres especiais na base de dados como acentos e cedilhas.

Podemos visualizar a base de dados digitando:

```{r, echo = TRUE}
res
```

Fazendo isso você verá somente parte da base de dados a depender do tamanho de sua janela do RStudio. Caso queira ver a tabela completa digite:

```{r, echo = TRUE, eval = FALSE}
View(res)
```

A base de dados é simplesmente uma tabela em que cada linha trás uma observação e cada coluna uma variável. Vamos realizar algumas operações para entender como explorar as informações na tabela.

## Verificando a base de dados

```{r, echo = TRUE}
glimpse(res)
```

O comando acima mostra cada uma das colunas e dados. Nesta tabela vemos dois tipos de dados `chr` identificando a coluna como uma variável qualitativa e `dbl` identificando uma variável quantitativa.

## Visualizando a base de dados

A tabela contém uma coluna denominada `Fechamento` que mostra a idade em que o reservatório foi formado. Vamos visualizar a tabela em ordem de idade, o mais antigo ao mais novo:

```{r, echo = TRUE, eval = FALSE}
res %>% 
  arrange(Fechamento) %>% 
  View()
```

O reservatório mais antigo é de `r min(res$Fechamento, na.rm = T)` e o mais novo de `r max(res$Fechamento, na.rm = T)`. Três reservatórios estão ao final da tabela pois para estes a variável `Fechamento` consta como faltante.

Se desejarmos visualizar a tabela em ordem **decresente**, basta fazermos:

```{r, echo = TRUE, eval = FALSE}
res %>% 
  arrange(desc(Fechamento)) %>% 
  View()
```

> Se utilizarmos as funções `arrange()` e/ou `desc()` com uma variável nominal, a tabela será organizada em ordem alfabética para esta variável.

```{r, echo = TRUE, eval = FALSE}
res %>% 
  arrange(Bacia) %>% 
  View()
```

## Selecionando colunas da tabela

É interessante, sobretudo para grandes bases de dados se pudermos selecionar sub-grupos de colunas. Podemos fazer isto facilmente utilizando a função `select()`.

Para selecionar por exemplo somente as colunas `Reservatório`, `Area` e `Riqueza`:

```{r, echo = TRUE, eval = F}
res %>% 
  select(Reservatorio, Area, Riqueza)
```

```{r}
res %>% 
  select(Reservatorio, Area, Riqueza) %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 10)
```

Ou se quisermos selecionar todas as variáveis **exceto** `Reservatório`

```{r, echo = TRUE, eval = F}
res %>% 
  select(-Reservatorio)
```

```{r}
res %>% 
  select(-Reservatorio) %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

Podemos também fazer uma seleção que vai desde uma coluna inicial até uma coluna final. Por exemplo, podemos selecionar todas as colunas desde `pH` **até** `P.total`. Para isto fazemos:

```{r, echo = TRUE, eval = F}
res %>% 
  select(pH:P.total)
```

```{r}
res %>% 
  select(pH:P.total) %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

Podemos ainda selecionar todas as variáveis categóricas:

```{r, echo = TRUE, eval = F}
res %>% 
  select_if(is.character)
```

```{r}
res %>% 
  select_if(is.character) %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

Ou todas as variáveis numéricas:

```{r, echo = TRUE, eval = F}
res %>% 
  select_if(is.numeric)
```

```{r}
res %>% 
  select_if(is.numeric) %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

Finalmente, podemos alterar a ordem das colunas:

```{r, echo = TRUE, eval = F}
nova_ordem = c('Fechamento', 'Area', 'Bacia', 'Reservatorio', 'CPUE', 'Riqueza',
               'Trofia', 'Condutividade', 'pH', 'P.total', 'Alcalinidade')
res %>% 
  select(nova_ordem)
```

```{r}
nova_ordem = c('Fechamento', 'Area', 'Bacia', 'Reservatorio', 'CPUE', 'Riqueza',
               'Trofia', 'Condutividade', 'pH', 'P.total', 'Alcalinidade')
res %>% 
  select_if(is.numeric) %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

## Filtrando linhas da tabela

Podemos fazer algo similar com as linhas utilizando a função `filter()`.

Digamos que queremos selecionar somente os reservatórios da bacia do rio Paranapanema:

```{r, echo = TRUE, eval = F}
res %>% 
  filter(Bacia == 'Paranapanema')
```

```{r}
res %>% 
  filter(Bacia == 'Paranapanema') %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

Ou todos **exceto** os da bacia do rio Paranapanema.

```{r, echo = TRUE, eval = F}
res %>% 
  filter(Bacia != 'Paranapanema')
```

```{r}
res %>% 
  filter(Bacia != 'Paranapanema') %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

> A função `filter()` utiliza operadores lógicos (retornam VERDADEIRO ou FALSO). Para aprender sobre este operadores no R veja [Operadores lógicos](https://fcopf.github.io/probest-introR/intro.html#operadores-l%C3%B3gicos)

Podemos realizar operações análogas para variáveis numéricas. Vamos selecionar somente os reservatórios com pH **menor** que $7.0$.

```{r, echo = TRUE, eval = F}
res %>% 
  filter(pH < 7)
```

```{r}
res %>% 
  filter(pH < 7) %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

Se quisermos pH's **menores ou iguais** a $7.0$ fazemos:

```{r, echo = TRUE, eval = F}
res %>% 
  filter(pH <= 7)
```

```{r}
res %>% 
  filter(pH <= 7) %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

## Adicionando ou modificando colunas

Podemos adicionar novas colunas assim como fazemos em uma planilha excel. Temos o ano de formação do reservatório. Assumindo que estes dados são de 2005, podemos criar uma coluna indicando a idade do reservatório no momento da tomada de dados. Para criar novas colunas usamos a função `mutate()`.

```{r, echo = TRUE, eval = F}
res = res %>% 
  mutate(Idade = 2005 - Fechamento)
res
```

```{r}
res = res %>% 
  mutate(Idade = 2005 - Fechamento)
res %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

A variável `Area` é dada em $km^2$. Podemos Hectares multiploicando os valores por 100.

```{r, echo = TRUE, eval = F}
res = res %>% 
  mutate(Area = Area * 100)
res
```

```{r}
res = res %>% 
  mutate(Area = Area * 100)
res %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```

## Renomeando colunas

Finalmente podemos renomear colunas para facilitar nossa compressão dos dados. A coluna `P.total` indica a quantidade de fósforo total e a variável `CPUE` é a captura. Podemos renomera estas colunas como:

```{r, echo = TRUE, eval = F}
res = res %>% 
  rename(Fosforo_total = P.total,
         Captura = CPUE)
res
```

```{r}
res = res %>% 
  rename(Fosforo_total = P.total,
         Captura = CPUE)
res %>% 
  kableExtra::kable(booktabs = TRUE) %>%
  kable_styling(font_size = 8)
```


```{r echo = FALSE}
rm(list = ls())
```

